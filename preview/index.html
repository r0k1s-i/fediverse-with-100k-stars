<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fediverse Universe Preview</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            overflow: hidden; 
            background: #0a0a1a; 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        #container { width: 100vw; height: 100vh; }
        
        #tooltip {
            position: fixed;
            padding: 12px 16px;
            background: rgba(10, 10, 26, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            color: #fff;
            font-size: 13px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            max-width: 280px;
            z-index: 1000;
        }
        #tooltip.visible { opacity: 1; }
        #tooltip .domain {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 6px;
            color: #4fc3f7;
        }
        #tooltip .software {
            color: rgba(255, 255, 255, 0.6);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        #tooltip .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px 12px;
            font-size: 12px;
        }
        #tooltip .stat-label { color: rgba(255, 255, 255, 0.5); }
        #tooltip .stat-value { color: #fff; text-align: right; }
        
        #controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 12px 16px;
            background: rgba(10, 10, 26, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            backdrop-filter: blur(10px);
        }
        #controls kbd {
            display: inline-block;
            padding: 2px 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            margin-right: 4px;
        }
        
        #info {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 16px 20px;
            background: rgba(10, 10, 26, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #fff;
            backdrop-filter: blur(10px);
        }
        #info h1 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        #info .stats {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }
        
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 16px;
        }
        #loading.hidden { display: none; }
    </style>
</head>
<body>
    <div id="container"></div>
    <div id="tooltip">
        <div class="domain"></div>
        <div class="software"></div>
        <div class="stats"></div>
    </div>
    <div id="controls">
        <kbd>Drag</kbd> Rotate
        <kbd>Scroll</kbd> Zoom
        <kbd>Right-drag</kbd> Pan
    </div>
    <div id="info">
        <h1>Fediverse Universe</h1>
        <div class="stats">Loading...</div>
    </div>
    <div id="loading">Loading Fediverse data...</div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        
        const container = document.getElementById('container');
        const tooltip = document.getElementById('tooltip');
        const loadingEl = document.getElementById('loading');
        const infoStats = document.querySelector('#info .stats');
        
        let scene, camera, renderer, controls;
        let instanceMeshes = [];
        let instances = [];
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        
        async function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a1a);
            
            const aspect = window.innerWidth / window.innerHeight;
            camera = new THREE.PerspectiveCamera(60, aspect, 1, 500000);
            camera.position.set(15000, 15000, 30000);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            container.appendChild(renderer.domElement);
            
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 1000;
            controls.maxDistance = 200000;
            
            const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
            scene.add(ambientLight);
            
            const pointLight = new THREE.PointLight(0xffffff, 1.5);
            pointLight.position.set(10000, 10000, 10000);
            scene.add(pointLight);
            
            createStarfield();
            
            try {
                const response = await fetch('../data/fediverse_final.json');
                instances = await response.json();
                createInstances(instances);
                loadingEl.classList.add('hidden');
                updateInfo(instances);
            } catch (err) {
                loadingEl.textContent = 'Error loading data: ' + err.message;
            }
            
            window.addEventListener('resize', onWindowResize);
            window.addEventListener('mousemove', onMouseMove);
            
            animate();
        }
        
        function createStarfield() {
            const geometry = new THREE.BufferGeometry();
            const positions = [];
            const colors = [];
            
            for (let i = 0; i < 5000; i++) {
                const x = (Math.random() - 0.5) * 200000;
                const y = (Math.random() - 0.5) * 200000;
                const z = (Math.random() - 0.5) * 200000;
                positions.push(x, y, z);
                
                const brightness = 0.3 + Math.random() * 0.7;
                colors.push(brightness, brightness, brightness * 0.9);
            }
            
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            
            const material = new THREE.PointsMaterial({
                size: 50,
                vertexColors: true,
                transparent: true,
                opacity: 0.8,
                sizeAttenuation: true
            });
            
            const stars = new THREE.Points(geometry, material);
            scene.add(stars);
        }
        
        function createInstances(data) {
            instanceMeshes = [];
            
            for (const inst of data) {
                const userCount = inst.stats?.user_count || 1;
                const radius = Math.max(80, Math.log(userCount + 1) * 40);
                
                const geometry = new THREE.SphereGeometry(radius, 16, 12);
                const color = new THREE.Color(inst.color?.hex || '#ffffff');
                
                const material = new THREE.MeshStandardMaterial({
                    color: color,
                    emissive: color,
                    emissiveIntensity: 0.3,
                    metalness: 0.3,
                    roughness: 0.7
                });
                
                const mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(inst.position.x, inst.position.y, inst.position.z);
                mesh.userData = inst;
                
                scene.add(mesh);
                instanceMeshes.push(mesh);
            }
        }
        
        function updateInfo(data) {
            const softwareTypes = new Set(data.map(i => i.software?.name)).size;
            const totalUsers = data.reduce((sum, i) => sum + (i.stats?.user_count || 0), 0);
            infoStats.innerHTML = `${data.length} instances | ${softwareTypes} software types | ${totalUsers.toLocaleString()} users`;
        }
        
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        function onMouseMove(event) {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(instanceMeshes);
            
            if (intersects.length > 0) {
                const inst = intersects[0].object.userData;
                showTooltip(event.clientX, event.clientY, inst);
            } else {
                hideTooltip();
            }
        }
        
        function showTooltip(x, y, inst) {
            tooltip.querySelector('.domain').textContent = inst.domain;
            tooltip.querySelector('.software').textContent = inst.software?.name || 'Unknown';
            
            const users = (inst.stats?.user_count || 0).toLocaleString();
            const posts = (inst.stats?.status_count || 0).toLocaleString();
            const mau = (inst.stats?.monthly_active_users || 0).toLocaleString();
            
            tooltip.querySelector('.stats').innerHTML = `
                <span class="stat-label">Users</span><span class="stat-value">${users}</span>
                <span class="stat-label">Posts</span><span class="stat-value">${posts}</span>
                <span class="stat-label">MAU</span><span class="stat-value">${mau}</span>
                <span class="stat-label">Type</span><span class="stat-value">${inst.positionType}</span>
            `;
            
            const offsetX = x + 15;
            const offsetY = y + 15;
            tooltip.style.left = offsetX + 'px';
            tooltip.style.top = offsetY + 'px';
            tooltip.classList.add('visible');
        }
        
        function hideTooltip() {
            tooltip.classList.remove('visible');
        }
        
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        
        init();
    </script>
</body>
</html>
