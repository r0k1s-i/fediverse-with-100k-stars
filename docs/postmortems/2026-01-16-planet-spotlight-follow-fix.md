# 尸检报告：王座模型渲染不一致与聚光灯失效排查

**日期**: 2026-01-16  
**影响范围**: `planet_325_the_king` 模型渲染与 Sketchfab 官图不一致  
**严重程度**: 中等（视觉问题）  
**状态**: 已解决  

---

## 背景与现象

目标是让王座模型在项目内尽量接近 Sketchfab 官图的舞台聚光效果。  
实际渲染中出现了多类问题：

1. 视觉整体偏“平”，缺少官图中“正上方圆形聚光束”  
2. 材质金属感过强，座面/扶手过亮且生硬  
3. 调试期间聚光灯时有时无，甚至所有模型都不生效  

---

## 复现步骤

1. 启动页面，选择显示王座模型  
2. 观察王座座面没有明显聚光束  
3. 尝试在控制台添加 SpotLight，部分参数生效、部分不生效  
4. 刷新后聚光灯消失，或限定“仅王座模型生效”后全部失效  

---

## 定位过程（按实际排查顺序）

### 1) 判断问题是否来自环境光或灯光数量

- HDR 环境贴图已分离，不是“星空反射导致失真”的旧问题  
- 多方向光 + ACES 暴露导致材质层次被洗平  
- 初步结论：需要聚光灯式的“集中束光”，而非泛光

### 2) 运行时引入聚光灯（SpotLight）

通过调参验证：
- 减少角度（`angle`）和提高强度能形成“聚焦束”  
- `penumbra` 控制边缘软硬  
- 聚光灯位置需接近正上方，指向座面中心

### 3) “可见但不稳定”问题

现象：运行时调到合适参数，刷新后又不可见  
原因：聚光灯没有跟随模型旋转，角度偏离导致效果消失  
处理：需要每帧基于模型 `matrixWorld` 更新位置/目标

### 4) “限定王座后全部失效”问题

现象：加入“仅王座模型启用”逻辑后，所有模型均不生效  
定位：匹配逻辑依赖 `model.userData.modelName`  
根因：`baseScene.clone(true)` 会丢失 `userData` 字段  
修复：克隆后显式复制 `modelName`

---

## 修复方案

### 1) 引入可配置聚光灯
- 使用 `SpotLight` 模拟官图正上方束光  
- 最终参数：
  - `intensity: 35`
  - `distance: 14`
  - `angle: Math.PI / 22`
  - `penumbra: 0.15`
  - `position: (0, 1, 0)`
  - `target: (0, 0.9, 0)`

### 2) 聚光灯随模型旋转
每帧根据模型 `matrixWorld` 计算世界坐标并更新 spotlight 位置/目标。

### 3) 仅对王座模型启用
通过 `modelMatch: "planet_325_the_king"` 限定启用范围。  
保证其他模型不受影响。

### 4) 修复克隆后元数据丢失
克隆 `baseScene` 后显式复制 `userData.modelName`，保证匹配逻辑有效。

---

## 关键验证与定位指令（控制台）

1. 查看场景内灯光是否存在  
2. 强制提高聚光灯强度验证可见性  
3. 检查模型材质是否 `MeshStandardMaterial`  
4. 验证 `model.userData.modelName` 是否存在  

---

## 经验教训

1. **渲染问题不总是“灯光参数”**  
   逻辑条件失败（如匹配失败）会让灯光“存在但无效”。

2. **模型克隆会丢失 `userData`**  
   若依赖 `userData` 做行为判断，必须显式复制。

3. **官图聚光需要“束光”，不是泛光**  
   `SpotLight` 的 `angle/penumbra/position` 是关键，不应靠方向光硬调。

4. **灯光应跟随模型**  
   模型旋转时，灯光若固定在世界坐标，会导致效果消失或跑位。

---

## 如何避免再次出现

1. **标准化模型元数据复制流程**  
   克隆后统一调用元数据复制函数，确保 `modelName` 可用。

2. **为“模型限定逻辑”写测试**  
   断言克隆后仍可命中模型匹配规则。

3. **调试时同时检查渲染与条件链路**  
   灯光存在 != 灯光生效，必须验证启用条件。

4. **建立“灯光基线配置”**  
   对常见模型（王座/点灯人）固定基线参数，减少反复试错。
